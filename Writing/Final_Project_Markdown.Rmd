---
title: "ERHS 535 Final Project: Prediction of West Niles Virus Human Cases in Southern California by Precipitation and Temperature from 2006-2010"
author: "Devin, Anastasia, Grant, Ana"
date: "11/7/2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

## Packages used in the final project
```{r, Packages needed}
library(dplyr)
library(stringr)
library(tidyselect)
library(ggplot2)
library(rmarkdown)
library(RColorBrewer)
library(knitr)
library(forcats)
library(readr)
library(tidyr)
library(broom)
library(purrr)
library(scales)
library(lubridate)
library(viridis)
library(RColorBrewer)
library(scales)
library(tidyverse)
library(sf)
library(tigris)
library(shiny)
library(gridExtra)
```

## Uploading California weather datasets 

Datasets were downloaded from CDC Wonder for the years 2006 to 2011 (from January 1st to December 31st)

[CDC Wonder](https://wonder.cdc.gov/)

#West Niles Data:

```{r upload WNV data}
report <-  read_csv( "../Data/wnv_human_cases.csv")
```

Change week to date

```{r clean WNV data}

a <- report %>%
  filter(Year == "2006") 
a <- a %>% 
  mutate(Date = lubridate::ymd( "2006-01-01" ) + lubridate::weeks(a$`Week Reported` - 1 ))
b <- report %>%
  filter(Year == "2007")
b <- b %>% 
  mutate(Date = lubridate::ymd( "2007-01-01" ) + lubridate::weeks(b$`Week Reported` - 1 ))
c <- report %>%
  filter(Year == "2008")
c <- c %>% 
  mutate(Date = lubridate::ymd( "2008-01-01" ) + lubridate::weeks(c$`Week Reported` - 1 ))
d <- report %>%
  filter(Year == "2009")
d <- d %>% 
  mutate(Date = lubridate::ymd( "2009-01-01" ) + lubridate::weeks(d$`Week Reported` - 1 ))
e <- report %>%
  filter(Year == "2010")
e <- e %>% 
  mutate(Date = lubridate::ymd( "2010-01-01" ) + lubridate::weeks(e$`Week Reported` - 1 ))

ab <- merge(a,b, all = TRUE)
abc <- merge(ab, c, all = TRUE)
abcd <- merge(abc, d, all = TRUE)
abcde <- merge(abcd, e, all = TRUE)
```

```{r Collapse WNV data by month}
cases <- abcde %>% 
  mutate(month = month(Date)) %>% 
  select(year = Year, 
         county = County, 
         positive_cases = "Positive Cases",
         month) %>% 
  group_by(year, county, month) %>% 
  summarize(positive_cases = sum(positive_cases)) %>% 
  ungroup

cases  
```

#Temperature and precipitation data: 

1. Uploading datasets

```{r uploading datasets}
temp_2006 <- read_csv("../Data/temp/temp_2006.csv")
temp_2007 <- read_csv("../Data/temp/temp_2007.csv")
temp_2008 <- read_csv("../Data/temp/temp_2008.csv")
temp_2009 <- read_csv("../Data/temp/temp_2009.csv")
temp_2010 <- read_csv("../Data/temp/temp_2010.csv")
temp_2011 <- read_csv("../Data/temp/temp_2011.csv")
precip_2006 <- read_csv("../Data/precip/precip_2006.csv")
precip_2007 <- read_csv("../Data/precip/precip_2007.csv")
precip_2008 <- read_csv("../Data/precip/precip_2008.csv")
precip_2009 <- read_csv("../Data/precip/precip_2009.csv")
precip_2010 <- read_csv("../Data/precip/precip_2010.csv")
precip_2011 <- read_csv("../Data/precip/precip_2011.csv")

```

2. Creating a dataframe with air temperature (Â°F) information of California for the years 2006 to 2011.

```{r, binding temperature datasets (2006-2011)}

temp <- rbind(temp_2006, temp_2007, temp_2008, temp_2009, 
              temp_2010, temp_2011)

temp <- temp %>% 
  select(County, "County Code", "Month Day, Year Code", "Day of Year", 
         "Avg Daily Max Air Temperature (F)", 
         "Avg Daily Min Air Temperature (F)") %>% 
  rename(county = County,
         fips = "County Code",
         date = "Month Day, Year Code",
         day_year = "Day of Year",
         max_temp_f = "Avg Daily Max Air Temperature (F)",
         min_temp_f = "Avg Daily Min Air Temperature (F)") %>% 
  mutate(date = mdy(date))
head(temp)
tail(temp)
```

3. Creating a dataframe with the precipitation (mm) information of California for the years 2006 to 2011.

```{r, binding precipitation datasets (2006-2011)}

precip <- rbind(precip_2006, precip_2007, precip_2008, precip_2009, 
              precip_2010, precip_2011)

precip <- precip %>%
  select(County, "Month Day, Year Code", "Avg Daily Precipitation (mm)")%>%
  rename(county = County,
         date = "Month Day, Year Code",
         avg_precip = "Avg Daily Precipitation (mm)") %>% 
  mutate(date = mdy(date))

head(precip)
tail(precip)
```

4. Merging temperature and precipitation of CA by date and county to have just one main dataframe with weather conditions for the years 2006 to 2011.

```{r, merging precipitations and temperature}

ca_weather <- merge(temp, precip, by = c("county", "date"))
head(ca_weather)
tail(ca_weather)

```

```{r clean precipitation data}

ca_precip <- ca_weather %>% 
  select(county, date, fips, avg_precip) %>% 
  separate(county, c("county", "state"), sep = " County, CA") %>% 
  select(county, date, fips, avg_precip) %>% 
  mutate(month = month(date)) %>% 
  mutate(year = year(date)) %>% 
  group_by(county, fips, month, year) %>% 
  summarise(avg_precip = mean(avg_precip)) %>% 
  ungroup %>% 
  arrange(year)

head(ca_precip) 

```

#Merge datasets

```{r merge datasets}

ca_precip_cases <- full_join(ca_precip, cases, by = c('month', 'year', 'county'))

ca_precip_cases$positive_cases[is.na(ca_precip_cases$positive_cases)] <- 0

ca_precip_cases <- ca_precip_cases %>% 
  arrange(desc(positive_cases))

head(ca_precip_cases)
```

```{r, create CA county map}
ca_counties <- counties(state = "CA", cb = TRUE, class = "sf")

ggplot() + 
  geom_sf(data = ca_counties)

```

```{r, joining geogrph with ca_county_cases }
#With the last changes our variables changed. this would be the code for the "new" data set

ca_county_cases <- ca_counties %>% 
 mutate(fips = paste(STATEFP, COUNTYFP, sep = "")) %>% 
 full_join(ca_precip_cases, by = "fips") %>% 
   arrange(desc(positive_cases))
head(ca_county_cases)
```

```{r, map of an specific date, fig.width=20, fig.height=10}
#With the last changes our variables changed. this would be the code for the "new" map
cases_plot <- ca_county_cases %>% 
  filter(month == "8" & year == "2008") %>% 
  ggplot() + 
  geom_sf(aes(fill = positive_cases)) + 
  scale_fill_viridis(name = "Number of cases")

precip_plot <- ca_county_cases %>% 
  filter(month == "8" & year == "2008")  %>% 
  ggplot() + 
  geom_sf(aes(fill = avg_precip)) + 
  scale_fill_viridis(name = "Average Precipitation")

grid.arrange(cases_plot, precip_plot, nrow = 1)


```

